<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datasets - MoveDot</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=7">
    <link rel="shortcut icon" href="/static/favicon.svg?v=7">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=7">
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="/css/base/styles.css?v=5">
    <link rel="stylesheet" href="/css/components/effects.css?v=5">
    <link rel="stylesheet" href="/css/components/framer-components.css?v=5">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Animated Grid Pattern Background - Same as Hero -->
    <svg class="hero-grid-pattern" aria-hidden="true">
        <defs>
            <pattern id="hero-grid" width="40" height="40" patternUnits="userSpaceOnUse" x="0" y="0">
                <path d="M.5 40V.5H40" fill="none" stroke="rgba(255, 255, 255, 0.12)" stroke-width="0.5"/>
            </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#hero-grid)" />
        <g class="hero-grid-squares"></g>
    </svg>

    <div id="app">
        <!-- Main Content -->
        <main class="datasets-main">
            <!-- Datasets Card -->
            <div class="datasets-card">
                <!-- Card Header -->
                <div class="card-header">
                    <h1 class="card-title">Datasets</h1>
                    <div class="header-controls" style="display:flex; align-items:center; gap:0.5rem;">
                        <span class="dataset-count" id="dataset-count">Loading...</span>
                        <button class="refresh-btn" onclick="refreshDatasets()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Scrollable Content -->
                <div class="card-content">
                    <div class="datasets-list" id="all-datasets">
                        <!-- All datasets will be loaded here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Floating Dock -->
        <nav class="floating-dock" id="floating-dock">
            <button class="dock-item" data-page="home" onclick="navigateTo('home.html')">
                <div class="dock-item-icon">
                    <i class="fas fa-home"></i>
                </div>
                <div class="dock-item-tooltip">Home</div>
            </button>
            
            <button class="dock-item" data-page="dashboard" onclick="navigateTo('index.html')">
                <div class="dock-item-icon">
                    <i class="fas fa-tachometer-alt"></i>
                </div>
                <div class="dock-item-tooltip">Dashboard</div>
            </button>
            
            <button class="dock-item" data-page="analytics" onclick="navigateTo('index.html')">
                <div class="dock-item-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="dock-item-tooltip">Analytics</div>
            </button>
            
            <button class="dock-item active" data-page="data-sources" onclick="navigateTo('data-sources.html')">
                <div class="dock-item-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="dock-item-tooltip">Datasets</div>
            </button>
            
            <button class="dock-item" data-page="mcp-servers" onclick="navigateTo('mcp-servers.html')">
                <div class="dock-item-icon">
                    <i class="fas fa-plug"></i>
                </div>
                <div class="dock-item-tooltip">Servers</div>
            </button>
        </nav>
    </div>

    <script src="/js/components/auth-guard.js"></script>
    <script src="/js/core/app.js?v=5"></script>
    <script>
        // Initialize Grid Pattern Animation
        function initGridPattern() {
            const bgContainer = document.querySelector('.hero-grid-pattern');
            const squaresContainer = document.querySelector('.hero-grid-squares');
            
            if (!bgContainer || !squaresContainer) {
                return;
            }
            
            const gridSize = 40;
            const numSquares = 50;
            let squares = [];

            function getRandomPos() {
                const maxX = Math.max(1, Math.floor(window.innerWidth / gridSize));
                const maxY = Math.max(1, Math.floor(window.innerHeight / gridSize));
                return [
                    Math.floor(Math.random() * maxX),
                    Math.floor(Math.random() * maxY)
                ];
            }

            function generateSquares() {
                squares = Array.from({ length: numSquares }, (_, i) => ({
                    id: i,
                    pos: getRandomPos()
                }));
            }

            function updateSquarePosition(id) {
                const newPos = getRandomPos();
                squares = squares.map(sq =>
                    sq.id === id ? { ...sq, pos: newPos } : sq
                );
                return newPos;
            }

            function createSquares() {
                squaresContainer.innerHTML = '';
                
                squares.forEach(({ pos: [x, y], id }, index) => {
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('class', 'hero-grid-square');
                    rect.setAttribute('width', gridSize - 1);
                    rect.setAttribute('height', gridSize - 1);
                    rect.setAttribute('x', x * gridSize + 1);
                    rect.setAttribute('y', y * gridSize + 1);
                    rect.style.animationDelay = `${index * 0.1}s`;
                    
                    let animationCount = 0;
                    rect.addEventListener('animationiteration', () => {
                        animationCount++;
                        if (animationCount % 2 === 0) {
                            const newPos = updateSquarePosition(id);
                            rect.setAttribute('x', newPos[0] * gridSize + 1);
                            rect.setAttribute('y', newPos[1] * gridSize + 1);
                        }
                    });
                    
                    squaresContainer.appendChild(rect);
                });
                
            }

            setTimeout(() => {
                generateSquares();
                createSquares();
            }, 100);

            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    generateSquares();
                    createSquares();
                }, 200);
            });
        }
        
        // Initialize grid on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGridPattern);
        } else {
            initGridPattern();
        }
        
        // Simple Datasets Manager
        class DatasetsManager {
            constructor() {
                this.datasets = [];
                this.init();
            }
            
            async init() {
                await this.loadDatasets();
                this.renderDatasets();
            }
            
            async loadDatasets() {
                try {
                    const response = await fetch('/api/data/overview');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    // Transform API data to our format
                    this.datasets = data.available_datasets.map(file => ({
                        name: file.name,
                        size: this.formatFileSize(file.size),
                        source: file.source || 'OpenF1'
                    }));
                    
                } catch (error) {
                    this.datasets = [];
                    this.showError(`Failed to load datasets: ${error.message}. Please check your connection and try again.`);
                }
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }
            
            renderDatasets() {
                const countElement = document.getElementById('dataset-count');
                const container = document.getElementById('all-datasets');
                
                if (!countElement || !container) {
                    return;
                }
                
                // Update count
                countElement.textContent = `${this.datasets.length} datasets`;
                
                if (this.datasets.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-database"></i>
                            </div>
                            <h3>No datasets available</h3>
                            <p>Get started by fetching data</p>
                        </div>
                    `;
                    return;
                }
                
                // Render all datasets in a single list
                container.innerHTML = this.datasets.map(dataset => `
                    <div class="dataset-item" onclick="analyzeDataset('${dataset.name}')">
                        <div class="dataset-icon">
                            <i class="fas fa-file-csv"></i>
                        </div>
                        <div class="dataset-details">
                            <h4>${this.getDisplayName(dataset.name)}</h4>
                            <div class="dataset-meta">
                                <span class="dataset-size">${dataset.size}</span>
                                <span class="dataset-source">${dataset.source}</span>
                            </div>
                        </div>
                        <div class="dataset-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                `).join('');
            }
            
            getDisplayName(fileName) {
                // Clean up the filename for display
                return fileName
                    .replace(/^openf1_/, '')
                    .replace(/\.csv$/, '')
                    .replace(/_/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());
            }
            
            showError(message) {
                const container = document.getElementById('all-datasets');
                if (!container) {
                    return;
                }
                
                container.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>Error Loading Data</h3>
                        <p>${message}</p>
                        <button class="retry-btn" onclick="refreshDatasets()">
                            <i class="fas fa-sync-alt"></i> Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // Navigation function (can use global or local)
        function navigateTo(page) {
            window.location.href = page;
        }
        
        // Analyze dataset function
        function analyzeDataset(datasetName) {
            showDatasetVisualization(datasetName);
        }
        
        // Show dataset visualization function
        function showDatasetVisualization(datasetName) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'dataset-modal-overlay';
            modalOverlay.innerHTML = `
                <div class="dataset-modal">
                    <div class="modal-header">
                        <div class="dataset-title-container">
                            <h2 id="dataset-title">Dataset Preview</h2>
                            <span id="dataset-original-name" class="dataset-original-name">${datasetName}</span>
                        </div>
                        <div class="header-actions">
                            <button class="btn-minimal" onclick="analyzeDatasetInChat('${datasetName}')">
                                <i class="fas fa-comments"></i>
                                Analyze
                            </button>
                            <button class="btn-secondary" onclick="downloadDataset('${datasetName}')">
                                <i class="fas fa-download"></i>
                                Download
                            </button>
                            <button class="close-modal" onclick="closeDatasetVisualization()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="modal-content">
                        <div class="loading-dataset">
                            <div class="loader-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <p>Loading dataset...</p>
                        </div>
                        <div class="dataset-preview" style="display: none;">
                            <div class="dataset-info-minimal">
                                <span class="dataset-stats">
                                    <span id="dataset-rows">-</span> rows • 
                                    <span id="dataset-columns">-</span> cols • 
                                    <span id="dataset-size">-</span>
                                </span>
                            </div>
                            <div class="dataset-table-container">
                                <table class="dataset-table" id="dataset-table">
                                    <!-- Table content will be populated here -->
                                </table>
                            </div>
                            <div class="dataset-preview-disclaimer">
                                <i class="fas fa-info-circle"></i>
                                This is a preview of the first 15 rows. Download the full dataset to see all data.
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // Close modal when clicking outside
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeDatasetVisualization();
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeDatasetVisualization();
                }
            });
            
            // Load dataset data
            loadDatasetData(datasetName);
            
            // Format dataset title
            formatDatasetTitle(datasetName);
            
        }
        
        // Format dataset title function
        function formatDatasetTitle(datasetName) {
            const titleElement = document.getElementById('dataset-title');
            const originalNameElement = document.getElementById('dataset-original-name');
            
            if (titleElement && originalNameElement) {
                // Format the dataset name to be more readable
                let formattedName = datasetName
                    .replace(/\.csv$/, '') // Remove .csv extension
                    .replace(/_/g, ' ') // Replace underscores with spaces
                    .replace(/\b\w/g, l => l.toUpperCase()) // Capitalize first letter of each word
                    .replace(/\bopenf1\b/g, 'OpenF1') // Special case for OpenF1
                    .replace(/\bapi\b/g, 'API') // Special case for API
                    .replace(/\bid\b/g, 'ID') // Special case for ID
                    .replace(/\burl\b/g, 'URL'); // Special case for URL
                
                titleElement.textContent = formattedName;
                originalNameElement.textContent = datasetName;
            }
        }
        
        
        // Load dataset data function
        async function loadDatasetData(datasetName) {
            try {
                const response = await fetch(`/api/data/preview/${encodeURIComponent(datasetName)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Hide loading, show preview
                document.querySelector('.loading-dataset').style.display = 'none';
                const preview = document.querySelector('.dataset-preview');
                preview.style.display = 'flex';
                
                // Update dataset info
                document.getElementById('dataset-rows').textContent = data.rows || '-';
                document.getElementById('dataset-columns').textContent = data.columns || '-';
                document.getElementById('dataset-size').textContent = data.size || '-';
                
                // Populate table with pandas DataFrame data
                if (data.data && Array.isArray(data.data)) {
                    populateDatasetTable(data.data);
                } else if (data.preview && Array.isArray(data.preview)) {
                    populateDatasetTable(data.preview);
                } else {
                    throw new Error('No valid data found in response');
                }
                
                // Adjust modal height based on number of rows
                adjustModalHeight(data.data?.length || data.preview?.length || 0);
                
            } catch (error) {
                document.querySelector('.loading-dataset').innerHTML = `
                    <div class="error-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <p>Error loading dataset: ${error.message}</p>
                    <button class="btn-secondary" onclick="loadDatasetData('${datasetName}')" style="margin-top: 1rem;">
                        <i class="fas fa-redo"></i>
                        Try Again
                    </button>
                `;
            }
        }
        
        // Adjust modal height based on content
        function adjustModalHeight(rowCount) {
            const modal = document.querySelector('.dataset-modal');
            if (!modal) return;
            
            // Calculate appropriate height based on rows
            // Each row is approximately 40px, header is ~100px, info bar ~60px, disclaimer ~40px
            const baseHeight = 200; // Header + info + disclaimer + padding
            const rowHeight = 40;
            const maxDisplayRows = Math.min(rowCount, 15);
            const contentHeight = baseHeight + (maxDisplayRows * rowHeight);
            
            // Set height with min and max constraints
            const finalHeight = Math.min(Math.max(contentHeight, 400), window.innerHeight * 0.85);
            modal.style.height = `${finalHeight}px`;
        }
        
        // Populate dataset table
        function populateDatasetTable(data) {
            const table = document.getElementById('dataset-table');
            if (!table) {
                return;
            }
            
            table.innerHTML = ''; // Clear existing content
            
            if (!data || data.length === 0) {
                table.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 2rem; color: var(--text-muted);">No data available</td></tr>';
                return;
            }
            
            // Get headers from first row
            const headers = Object.keys(data[0]);
            if (headers.length === 0) {
                table.innerHTML = '<tr><td colspan="100%" style="text-align: center; padding: 2rem; color: var(--text-muted);">No columns found</td></tr>';
                return;
            }
            
            // Create header row
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                th.title = header; // Tooltip for long column names
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);
            
            // Create data rows (limit to 15 rows for preview)
            const maxRows = Math.min(15, data.length);
            for (let i = 0; i < maxRows; i++) {
                const row = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    const value = data[i][header];
                    
                    // Handle different data types
                    if (value === null || value === undefined) {
                        td.textContent = '';
                        td.style.color = 'var(--text-muted)';
                        td.style.fontStyle = 'italic';
                    } else if (typeof value === 'number') {
                        // Format numbers nicely
                        if (Number.isInteger(value)) {
                            td.textContent = value.toLocaleString();
                        } else {
                            td.textContent = value.toFixed(4);
                        }
                    } else {
                        // Convert to string and truncate if too long
                        const stringValue = String(value);
                        if (stringValue.length > 50) {
                            td.textContent = stringValue.substring(0, 47) + '...';
                            td.title = stringValue; // Show full value on hover
                        } else {
                            td.textContent = stringValue;
                        }
                    }
                    
                    row.appendChild(td);
                });
                table.appendChild(row);
            }
            
            // Add "more rows" indicator if needed
            if (data.length > maxRows) {
                const moreRow = document.createElement('tr');
                const moreCell = document.createElement('td');
                moreCell.colSpan = headers.length;
                moreCell.textContent = `... and ${data.length - maxRows} more rows`;
                moreCell.style.textAlign = 'center';
                moreCell.style.fontStyle = 'italic';
                moreCell.style.color = 'var(--text-muted)';
                moreCell.style.padding = '1rem';
                moreRow.appendChild(moreCell);
                table.appendChild(moreRow);
            }
        }
        
        // Close dataset visualization
        function closeDatasetVisualization() {
            const modal = document.querySelector('.dataset-modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
        
        // Analyze dataset in chat
        function analyzeDatasetInChat(datasetName) {
            // Close the modal first
            closeDatasetVisualization();
            
            // Store the dataset name in localStorage for the chat page to use
            localStorage.setItem('pendingDatasetAnalysis', datasetName);
            
            // Redirect to chat page with query parameter as backup
            window.location.href = `index.html?analyze=${encodeURIComponent(`Analyze the dataset ${datasetName}`)}`;
        }
        
        // Download dataset
        function downloadDataset(datasetName) {
            const link = document.createElement('a');
            link.href = `/api/data/download/${encodeURIComponent(datasetName)}`;
            link.download = datasetName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Refresh datasets function
        function refreshDatasets() {
            if (window.datasetsManager) {
                window.datasetsManager.init();
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            try {
                window.datasetsManager = new DatasetsManager();
            } catch (error) {
                // Failed to initialize DatasetsManager
            }
        });
    </script>
</body>
</html>
